/*
* Angular SDK to use with backand 
* @version 1.7.2 - 2015-09-03
* @link https://backand.com 
* @author Itay Herskovits 
* @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){function a(a,b){var c=h[a],d=b?"up":"in";return"user/socialSign"+d+"?provider="+c.label+"&response_type=token&client_id=self&redirect_uri="+c.url+"&state="}function b(a,b,c,d){return{request:function(a){if(!b.isManagingDefaultHeaders())return a;if(!a.url.match(b.getApiUrl()))return a;if(a.url.match(b.getApiUrl()+"/token"))return a;var c=e.token.get();return angular.isDefined(c)&&(a.headers.Authorization=c),f.anonymousToken&&(a.headers.AnonymousToken=f.anonymousToken),a},responseError:function(e){if(e.config.url!==b.getApiUrl()+"token"&&401===e.status){d.refreshToken(b.getUsername());var f=a.defer();return c.append(e.config,f),f.promise}return a.reject(e)}}}function c(b,c,i){function j(a){if(l.socialAuthWindow.close(),l.socialAuthWindow=null,a.origin===location.origin){var b=JSON.parse(a.data);if(b.error){var c={data:b.error.message+" (signing in with "+b.error.provider+")"};c.error_description=c.data,l.loginPromise.reject(c)}else{if(b.data)return l.signinWithToken(b.data);l.loginPromise.reject()}}}function k(a){return m?void 0:(m=!0,e.token.clear(),d({method:"POST",url:f.apiUrl+"/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];return angular.forEach(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(a))}),b.join("&")},data:a}).then(function(a){return a.data&&a.data.access_token?(f.token="bearer "+a.data.access_token,e.token.set(f.token),e.user.set(a.data),l.loginPromise&&l.loginPromise.resolve(f.token),i.retryAll(),c.$broadcast(g.SIGNIN)):l.loginPromise&&l.loginPromise.reject("token is undefined"),a.data})["catch"](function(a){return l.loginPromise&&l.loginPromise.reject(a),b.reject(a.data)})["finally"](function(){m=!1}))}var l=this,m=!1;l.signin=function(a,b){var c={grant_type:"password",username:a,password:b,appname:f.appName};return k(c)},l.signout=function(){return e.token.clear(),e.user.clear(),i.rejectAll("signed out"),c.$broadcast(g.SIGNOUT),b.when(!0)},l.signup=function(a,b,e,h,i,j){return d({method:"POST",url:f.apiUrl+"/1/user/signup",headers:{SignUpToken:f.signUpToken},data:{firstName:a,lastName:b,email:e,password:h,confirmPassword:i,parameters:j}}).then(function(a){return c.$broadcast(g.SIGNUP),a})},l.socialAuth=function(c,d,e){if(!h[c])throw Error("Unknown Social Provider");return l.loginPromise=b.defer(),l.socialAuthWindow=window.open(f.apiUrl+"/1/"+a(c,d)+"&appname="+f.appName+"&returnAddress=","id1",e||"left=1, top=1, width=600, height=600"),window.addEventListener("message",j,!1),l.loginPromise.promise},l.signinWithToken=function(a){var b={grant_type:"password",accessToken:a.access_token,appName:f.appName};return k(b)},l.refreshToken=function(a){e.token.clear();var b,c=e.user.get();if(c&&(b=e.user.get().refresh_token)){var d={grant_type:"password",refreshToken:b,username:a,appName:f.appName};return k(d)}},l.requestResetPassword=function(a,b){return b&&l.setAppName(b),d({method:"POST",url:f.apiUrl+"/1/user/requestResetPassword",data:{appName:f.appName,username:a}})},l.resetPassword=function(a,b){return d({method:"POST",url:f.apiUrl+"/1/user/resetPassword",data:{newPassword:a,resetToken:b}})},l.changePassword=function(a,b){return d({method:"POST",url:f.apiUrl+"/1/user/changePassword",data:{oldPassword:a,newPassword:b}})}}var d,e=function(){"use strict";function a(a,c){var d;-1===["local","session"].indexOf(c)&&(c="local"),d="undefined"!=typeof window&&"undefined"!=typeof window[c+"Storage"]?window[c+"Storage"]:{value:null,getItem:function(a,b){return this.value},setItem:function(a,b){this.value=b},removeItem:function(a,b){this.value=null}},this.command=function(c,e){return d[c+"Item"](b+a,e||null)}}var b="BACKAND";return a.prototype.get=function(){return JSON.parse(this.command("get"))},a.prototype.set=function(a){return this.command("set",JSON.stringify(a))},a.prototype.clear=function(){return this.command("set"),this},{register:function(b,c){if(!b)throw Error("Invalid Store Name");return this[b]=new a(b,c),this},remove:function(a){return this[a].command("remove"),delete this[a],this}}}(),f={apiUrl:"https://api.backand.com",tokenName:"backand_token",anonymousToken:null,signUpToken:null,isManagingDefaultHeaders:!1,appName:null,userProfileName:"backand_user"},g={SIGNIN:"BackandSignIn",SIGNOUT:"BackandSignOut",SIGNUP:"BackandSignUp"},h={github:{name:"github",label:"Github",url:"www.github.com",css:"github",id:1},google:{name:"google",label:"Google",url:"www.google.com",css:"google-plus",id:2},facebook:{name:"facebook",label:"Facebook",url:"www.facebook.com",css:"facebook",id:3}};e.register("token"),e.register("user"),function(){var a=/\?(data|error)=(.+)/,b=a.exec(location.href);if(b&&b[1]&&b[2]){var c={};c[b[1]]=JSON.parse(decodeURI(b[2].replace(/#.*/,""))),window.opener.postMessage(JSON.stringify(c),location.origin)}}(),angular.module("backand",["ngCookies"]).provider("Backand",function(){function a(a,b){var c=this;c.EVENTS=g,c.setAppName=function(a){f.appName=a},c.signin=function(a,d,e){return e&&c.setAppName(e),b.signin(a,d)},c.signout=function(){return b.signout()},c.signup=function(a,c,d,e,f,g){return b.signup(a,c,d,e,f,g)},c.getSocialProviders=function(){return h},c.socialSignin=function(a,c){return b.socialAuth(a,!1,c)},c.socialSignup=function(a,c){return b.socialAuth(a,!0,c)},c.requestResetPassword=function(a,d){return d&&c.setAppName(d),b.requestResetPassword(a,d)},c.resetPassword=function(a,c){return b.resetPassword(a,c)},c.changePassword=function(a,c){return b.changePassword(a,c)},c.getUserDetails=function(b){var c=a.defer();return b?d({method:"GET",url:f.apiUrl+"/api/account/profile"}).success(function(a){e.user.set(a),c.resolve(e.user.get())}):c.resolve(e.user.get()),c.promise},c.getUsername=function(){var a=e.user.get();return a?a.username:null},c.getUserRole=function(){var a=e.user.get();return a?a.role:null},c.getToken=function(){return e.token.get()},c.getTokenName=function(){return f.tokenName},c.getApiUrl=function(){return f.apiUrl},c.isManagingDefaultHeaders=function(){return f.isManagingDefaultHeaders},c.socialSignIn=c.socialSignin,c.socialSignUp=c.socialSignup,c.signInWithToken=c.signinWithToken}this.getApiUrl=function(){return f.apiUrl},this.setApiUrl=function(a){return f.apiUrl=a,this},this.getTokenName=function(a){return f.tokenName},this.setTokenName=function(a){return f.tokenName=a,this},this.setAnonymousToken=function(a){return f.anonymousToken=a,this},this.setSignUpToken=function(a){return f.signUpToken=a,this},this.setAppName=function(a){return f.appName=a,this},this.manageDefaultHeaders=function(a){return f.isManagingDefaultHeaders=void 0==a?!0:a,this},this.$get=["$q","BackandAuthService",function(b,c){return new a(b,c)}]}).run(["$injector",function(a){a.invoke(["$http",function(a){d=a}])}]),angular.module("backand").factory("BackandHttpInterceptor",["$q","Backand","BackandHttpBufferService","BackandAuthService",b]).config(["$httpProvider",function(a){a.interceptors.push("BackandHttpInterceptor")}]),angular.module("backand").service("BackandAuthService",["$q","$rootScope","BackandHttpBufferService",c]),function(){function a(a){function b(a,b){function c(a){b.resolve(a)}function e(a){b.reject(a)}d(a).then(c,e)}function c(a){return delete a.headers.Authorization,a}var e=this,f=[];e.append=function(a,b){f.push({config:a,deferred:b})},e.rejectAll=function(a){if(a)for(var b=0;b<f.length;++b)f[b].deferred.reject(a);f=[]},e.retryAll=function(){for(var a=0;a<f.length;++a)b(c(f[a].config),f[a].deferred);f=[]}}angular.module("backand").service("BackandHttpBufferService",["$injector",a])}()}();