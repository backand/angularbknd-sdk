/*
* Angular SDK to use with backand 
* @version 1.7.0 - 2015-07-29
* @link https://backand.com 
* @author Itay Herskovits 
* @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";var a,b,c,d,e,f;angular.module("backand",["ngCookies"]).provider("Backand",function(){function g(g){function i(a,b){var c=m[a],d=b?"up":"in";return"user/socialSign"+d+"?provider="+c.label+"&response_type=token&client_id=self&redirect_uri="+c.url+"&state=rcFNVUMsUOSNMJQZ%2bDTzmpqaGgSRGhUfUOyQHZl6gas%3d"}function j(a){if(a.origin===location.origin){var b=JSON.parse(a.data);return b.error?void l.loginPromise.reject({data:b.error.message+" (signing in with "+b.error.provider+")"}):b.data?l.signInWithToken(b.data):void l.loginPromise.reject()}}function k(a){return d.remove(),c.clear(),f({method:"POST",url:b.apiUrl+"/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];return angular.forEach(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(a))}),b.join("&")},data:a}).success(function(a){angular.isDefined(a)&&null!=a?angular.isDefined(a.access_token)&&(b.token="bearer "+a.access_token,d.set(b.token),c.set(),e.set(a),l.loginPromise.resolve(b.token)):l.loginPromise.reject("token is undefined")}).error(function(a){l.loginPromise.reject(a)}),l.loginPromise.promise}var l=this,m={github:{name:"github",label:"Github",url:"www.github.com",css:"github",id:1},google:{name:"google",label:"Google",url:"www.google.com",css:"google-plus",id:2},facebook:{name:"facebook",label:"Facebook",url:"www.facebook.com",css:"facebook",id:3}};l.getSocialProviders=function(){return m},l.socialSignIn=function(a,b){return l.socialAuth(a,b,!1)},l.socialSignUp=function(a,b){return l.socialAuth(a,b,!0)},l.socialAuth=function(a,c,d){return l.loginPromise=g.defer(),c=c||encodeURIComponent(location.href.replace(/\?.*/g,"")),window.open("https://api.backand.com:8079/1/"+i(a,d)+"&appname="+b.appName+"&returnAddress=","id1","left=10,top=10,width=600,height=600"),window.addEventListener("message",j,!1),l.loginPromise.promise},l.signin=function(a,c,d){l.loginPromise=g.defer(),d&&h.setAppName(d);var e={grant_type:"password",username:a,password:c,appname:b.appName};return k(e)},l.signInWithToken=function(a){var c={grant_type:"password",accessToken:a.access_token,appName:b.appName};return k(c)},l.getUserDetails=function(a){var c=g.defer();return a?f({method:"GET",url:b.apiUrl+"/1/account/profile"}).success(function(a){e.set(a),c.resolve(e.get())}):c.resolve(e.get()),c.promise},l.getUsername=function(){var c=a.get(b.userProfileName);return c?c.username:null},l.getUserRole=function(){var c=a.get(b.userProfileName);return c?c.role:null},l.signout=function(){return d.remove(),e.remove(),c.clear(),c.set(),g.when(!0)},l.signup=function(a,c,d,e,g){return f({method:"POST",url:b.apiUrl+"/1/user/signup",headers:{SignUpToken:b.signUpToken},data:{firstName:a,lastName:c,email:d,password:e,confirmPassword:g}})},l.requestResetPassword=function(a,c){return c&&h.setAppName(c),f({method:"POST",url:b.apiUrl+"/1/user/requestResetPassword",data:{appName:b.appName,username:a}})},l.resetPassword=function(a,c){return f({method:"POST",url:b.apiUrl+"/1/user/resetPassword",data:{newPassword:a,resetToken:c}})},l.changePassword=function(a,c){return f({method:"POST",url:b.apiUrl+"/1/user/changePassword",data:{oldPassword:a,newPassword:c}})},l.getToken=function(){return d.get()},l.getTokenName=function(){return b.tokenName},l.getApiUrl=function(){return b.apiUrl}}var h=this;b={apiUrl:"https://api.backand.com:8080",tokenName:"backand_token",anonymousToken:null,signUpToken:null,isManagingDefaultHeaders:!1,appName:null,userProfileName:"backand_user"},d={get:function(){return a.get(b.tokenName)},set:function(c){a.put(b.tokenName,c)},remove:function(){a.remove(b.tokenName)}},e={get:function(){return a.get(b.userProfileName)},set:function(c){a.put(b.userProfileName,c)},remove:function(){a.remove(b.userProfileName)}},c={set:function(){if(b.isManagingDefaultHeaders){var a=d.get();angular.isDefined(a)&&(f.defaults.headers.common.Authorization=a),b.anonymousToken&&(f.defaults.headers.common.AnonymousToken=b.anonymousToken)}},clear:function(){b.isManagingDefaultHeaders&&(f.defaults.headers.common.Authorization&&delete f.defaults.headers.common.Authorization,f.defaults.headers.common.AnonymousToken&&delete f.defaults.headers.common.AnonymousToken)}},this.getApiUrl=function(){return b.apiUrl},this.setApiUrl=function(a){return b.apiUrl=a,this},this.getTokenName=function(a){return b.tokenName},this.setTokenName=function(a){return b.tokenName=a,this},this.setAnonymousToken=function(a){return b.anonymousToken=a,this},this.setSignUpToken=function(a){return b.signUpToken=a,this},this.setAppName=function(a){return b.appName=a,this},this.manageDefaultHeaders=function(a){return void 0==a&&(a=!0),b.isManagingDefaultHeaders=a,this},this.$get=["$q",function(a){return new g(a)}]}).run(["$injector","$location",function(b,d){b.invoke(["$http","$cookieStore",function(b,c){a=c,f=b}]),c.set();var e=/\?(data|error)=(.+)/,g=e.exec(location.href);if(g&&g[1]&&g[2]){var h={};h[g[1]]=JSON.parse(decodeURI(g[2].replace("#.*",""))),window.opener.postMessage(JSON.stringify(h),location.origin),window.close()}}])}();