/*
* Angular SDK to use with backand 
* @version 1.8.0 - 2015-09-20
* @link https://backand.com 
* @author Itay Herskovits 
* @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){function a(a,b){var c=i[a],d=b?"up":"in";return"user/socialSign"+d+"?provider="+c.label+"&response_type=token&client_id=self&redirect_uri="+c.url+"&state="}function b(a,b,c,d){return{request:function(a){if(g.isManagingHttpInterceptor&&a.url.match(b.getApiUrl())&&!a.url.match(b.getApiUrl()+"/token")){var c=f.token.get();c&&(a.headers.Authorization=c),g.anonymousToken&&(a.headers.AnonymousToken=g.anonymousToken)}return a},responseError:function(e){if(g.isManagingHttpInterceptor&&e.config.url!==b.getApiUrl()+"token"&&g.isManagingRefreshToken&&401===e.status&&e.data&&"invalid or expired token"===e.data.Message){d.refreshToken(b.getUsername());var f=a.defer();return c.append(e.config,f),f.promise}return a.reject(e)}}}function c(b,c,d){function j(c,d,e){if(!i[c])throw Error("Unknown Social Provider");return n.loginPromise=b.defer(),n.socialAuthWindow=window.open(g.apiUrl+"/1/"+a(c,d)+"&appname="+g.appName+"&returnAddress=","id1",e||"left=1, top=1, width=600, height=600"),window.addEventListener("message",k,!1),n.loginPromise.promise}function k(a){if(n.socialAuthWindow.close(),n.socialAuthWindow=null,a.origin===location.origin){var b=JSON.parse(a.data);if(b.error){var d={data:b.error.message+" (signing in with "+b.error.provider+")"};d.error_description=d.data,n.loginPromise.reject(d)}else{if(b.data)return n.inSocialSignup&&(n.inSocialSignup=!1,c.$broadcast(h.SIGNUP)),l(b.data);n.loginPromise.reject()}}}function l(a){var b={grant_type:"password",accessToken:a.access_token,appName:g.appName};return n.signupParameters&&(b.parameters=n.signupParameters,n.signupParameters=null),m(b)}function m(a){return o?void 0:(o=!0,f.token.clear(),e({method:"POST",url:g.apiUrl+p.token,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];return angular.forEach(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(a))}),b.join("&")},data:a}).then(function(a){return a.data&&a.data.access_token?(g.token="bearer "+a.data.access_token,f.token.set(g.token),f.user.set(a.data),n.loginPromise&&n.loginPromise.resolve(g.token),d.retryAll(),c.$broadcast(h.SIGNIN)):n.loginPromise&&n.loginPromise.reject("token is undefined"),a.data})["catch"](function(a){return n.loginPromise&&n.loginPromise.reject(a),b.reject(a.data)})["finally"](function(){o=!1}))}var n=this,o=!1,p={signup:"/1/user/signup",token:"/token",requestResetPassword:"/1/user/requestResetPassword",resetPassword:"/1/user/resetPassword",changePassword:"/1/user/changePassword"};n.signin=function(a,b){var c={grant_type:"password",username:a,password:b,appname:g.appName};return m(c)},n.signout=function(){return f.token.clear(),f.user.clear(),d.rejectAll("signed out"),c.$broadcast(h.SIGNOUT),b.when(!0)},n.signup=function(a,b,d,f,i,j){return e({method:"POST",url:g.apiUrl+p.signup,headers:{SignUpToken:g.signUpToken},data:{firstName:a,lastName:b,email:d,password:f,confirmPassword:i,parameters:j}}).then(function(a){return c.$broadcast(h.SIGNUP),g.runSigninAfterSignup&&1===a.data.currentStatus?n.signin(d,f):a})},n.socialSignin=function(a,b){return j(a,!1,b)},n.socialSignup=function(a,b,c){return n.signupParameters=b,n.inSocialSignup=!0,j(a,!0,c)},n.refreshToken=function(a){f.token.clear();var b,c=f.user.get();if(c&&(b=f.user.get().refresh_token)){var d={grant_type:"password",refreshToken:b,username:a,appName:g.appName};return m(d)}},n.requestResetPassword=function(a){return e({method:"POST",url:g.apiUrl+p.requestResetPassword,data:{appName:g.appName,username:a}})},n.resetPassword=function(a,b){return e({method:"POST",url:g.apiUrl+p.resetPassword,data:{newPassword:a,resetToken:b}})},n.changePassword=function(a,b){return e({method:"POST",url:g.apiUrl+p.changePassword,data:{oldPassword:a,newPassword:b}})}}function d(a){var b=this;b.getUserDetails=function(b){var c=a.defer();return b?e({method:"GET",url:g.apiUrl+"/api/account/profile"}).success(function(a){f.user.set(angular.extend(f.user.get(),a)),c.resolve(f.user.get())}):c.resolve(f.user.get()),c.promise},b.getUsername=function(){var a;return(a=f.user.get())?a.username:null},b.getUserRole=function(){var a;return(a=f.user.get())?a.role:null}}var e,f=function(){"use strict";function a(a,c){var d;-1===["local","session"].indexOf(c)&&(c="local"),d="undefined"!=typeof window&&"undefined"!=typeof window[c+"Storage"]?window[c+"Storage"]:{value:null,getItem:function(a,b){return this.value},setItem:function(a,b){this.value=b},removeItem:function(a,b){this.value=null}},this.command=function(c,e){return d[c+"Item"](b+a,e||null)}}var b="BACKAND";return a.prototype.get=function(){return JSON.parse(this.command("get"))},a.prototype.set=function(a){return this.command("set",JSON.stringify(a))},a.prototype.clear=function(){return this.command("set"),this},{register:function(b,c){if(!b)throw Error("Invalid Store Name");return this[b]=new a(b,c),this},remove:function(a){return this[a].command("remove"),delete this[a],this}}}(),g={apiUrl:"https://api.backand.com",anonymousToken:null,signUpToken:null,isManagingHttpInterceptor:!0,isManagingRefreshToken:!0,runSigninAfterSignup:!0,appName:null,userProfileName:"backand_user"},h={SIGNIN:"BackandSignIn",SIGNOUT:"BackandSignOut",SIGNUP:"BackandSignUp"},i={github:{name:"github",label:"Github",url:"www.github.com",css:"github",id:1},google:{name:"google",label:"Google",url:"www.google.com",css:"google-plus",id:2},facebook:{name:"facebook",label:"Facebook",url:"www.facebook.com",css:"facebook",id:3}};f.register("token"),f.register("user"),function(){var a=/\?(data|error)=(.+)/,b=a.exec(location.href);if(b&&b[1]&&b[2]){var c={};c[b[1]]=JSON.parse(decodeURI(b[2].replace(/#.*/,""))),window.opener.postMessage(JSON.stringify(c),location.origin)}}(),angular.module("backand",[]).provider("Backand",function(){function a(a,b){var c=this;c.EVENTS=h,c.setAppName=function(a){g.appName=a},c.signin=function(b,c){return a.signin(b,c)},c.signout=function(){return a.signout()},c.signup=function(b,c,d,e,f,g){return a.signup(b,c,d,e,f,g)},c.getSocialProviders=function(){return i},c.socialSignin=function(b,c){return a.socialSignin(b,c)},c.socialSignup=function(b,c,d){return a.socialSignup(b,c,d)},c.requestResetPassword=function(b){return a.requestResetPassword(b)},c.resetPassword=function(b,c){return a.resetPassword(b,c)},c.changePassword=function(b,c){return a.changePassword(b,c)},c.getUserDetails=function(a){return b.getUserDetails(a)},c.getUsername=function(){return b.getUsername()},c.getUserRole=function(){return b.getUserRole()},c.getToken=function(){return f.token.get()},c.getTokenName=function(){return null},c.getApiUrl=function(){return g.apiUrl},c.isManagingDefaultHeaders=function(){return null},c.isManagingHttpInterceptor=function(){return g.isManagingHttpInterceptor},c.isManagingRefreshToken=function(){return g.isManagingRefreshToken&&f.user.get()&&f.user.get().refresh_token},c.socialSignIn=c.socialSignin,c.socialSignUp=c.socialSignup}this.getApiUrl=function(){return g.apiUrl},this.setApiUrl=function(a){return g.apiUrl=a,this},this.getTokenName=function(){return null},this.setTokenName=function(){return this},this.setAnonymousToken=function(a){return g.anonymousToken=a,this},this.setSignUpToken=function(a){return g.signUpToken=a,this},this.setAppName=function(a){return g.appName=a,this},this.manageDefaultHeaders=function(a){return this},this.manageHttpInterceptor=function(a){return g.isManagingHttpInterceptor=void 0==a?!0:a,this},this.manageRefreshToken=function(a){return g.isManagingRefreshToken=void 0==a?!0:a,this},this.runSigninAfterSignup=function(a){return g.runSigninAfterSignup=void 0==a?!0:a,this},this.$get=["BackandAuthService","BackandUserService",function(b,c){return new a(b,c)}]}).run(["$injector",function(a){a.invoke(["$http",function(a){e=a}])}]),angular.module("backand").factory("BackandHttpInterceptor",["$q","Backand","BackandHttpBufferService","BackandAuthService",b]).config(["$httpProvider",function(a){a.interceptors.push("BackandHttpInterceptor")}]),angular.module("backand").service("BackandAuthService",["$q","$rootScope","BackandHttpBufferService",c]),function(){function a(){function a(a,b){function c(a){b.resolve(a)}function d(a){b.reject(a)}e(a).then(c,d)}function b(a){return delete a.headers.Authorization,a}var c=this,d=[];c.append=function(a,b){d.push({config:a,deferred:b})},c.rejectAll=function(a){if(a)for(var b=0;b<d.length;++b)d[b].deferred.reject(a);d=[]},c.retryAll=function(){for(var c=0;c<d.length;++c)a(b(d[c].config),d[c].deferred);d=[]}}angular.module("backand").service("BackandHttpBufferService",a)}(),angular.module("backand").service("BackandUserService",["$q",d])}();