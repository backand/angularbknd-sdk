/*
* Angular SDK to use with backand 
* @version 1.7.2 - 2015-09-01
* @link https://backand.com 
* @author Itay Herskovits 
* @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";var a=/\?(data|error)=(.+)/,b=a.exec(location.href);if(b&&b[1]&&b[2]){var c={};c[b[1]]=JSON.parse(decodeURI(b[2].replace(/#.*/,""))),window.opener.postMessage(JSON.stringify(c),location.origin)}var d,e,f,g,h,i;angular.module("backand",["ngCookies"]).provider("Backand",function(){function a(a,b,c){function j(a,b){var c=o[a],d=b?"up":"in";return"user/socialSign"+d+"?provider="+c.label+"&response_type=token&client_id=self&redirect_uri="+c.url+"&state="}function k(a){if(m.socialAuthWindow.close(),m.socialAuthWindow=null,a.origin===location.origin){var b=JSON.parse(a.data);return b.error?void m.loginPromise.reject({data:b.error.message+" (signing in with "+b.error.provider+")"}):b.data?m.signinWithToken(b.data):void m.loginPromise.reject()}}function l(a){return n?void 0:(n=!0,g.remove(),f.clear(),i({method:"POST",url:e.apiUrl+"/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];return angular.forEach(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(a))}),b.join("&")},data:a}).then(function(a){return a.data&&a.data.access_token?(e.token="bearer "+a.data.access_token,g.set(e.token),f.set(),h.set(a.data),m.loginPromise&&m.loginPromise.resolve(e.token),c.retryAll(),b.$broadcast(m.EVENTS.SIGNIN)):m.loginPromise&&m.loginPromise.reject("token is undefined"),a.data})["catch"](function(a){m.loginPromise&&m.loginPromise.reject(a)})["finally"](function(){n=!1}))}var m=this,n=!1;m.EVENTS={SIGNIN:"BackandSignIn",SIGNOUT:"BackandSignOut"},m.setAppName=function(a){e.appName=a};var o={github:{name:"github",label:"Github",url:"www.github.com",css:"github",id:1},google:{name:"google",label:"Google",url:"www.google.com",css:"google-plus",id:2},facebook:{name:"facebook",label:"Facebook",url:"www.facebook.com",css:"facebook",id:3}};m.getSocialProviders=function(){return o},m.socialSignin=function(a){return m.socialAuth(a,!1)},m.socialSignup=function(a){return m.socialAuth(a,!0)},m.socialAuth=function(b,c){return m.loginPromise=a.defer(),m.socialAuthWindow=window.open(e.apiUrl+"/1/"+j(b,c)+"&appname="+e.appName+"&returnAddress=","id1","left=10, top=10, width=600, height=600"),window.addEventListener("message",k,!1),m.loginPromise.promise},m.signin=function(a,b,c){c&&m.setAppName(c);var d={grant_type:"password",username:a,password:b,appname:e.appName};return l(d)},m.signinWithToken=function(a){var b={grant_type:"password",accessToken:a.access_token,appName:e.appName};return l(b)},m.getUserDetails=function(b){var c=a.defer();return b?i({method:"GET",url:e.apiUrl+"/api/account/profile"}).success(function(a){h.set(a),c.resolve(h.get())}):c.resolve(h.get()),c.promise},m.getUsername=function(){var a=d.get(e.userProfileName);return a?a.username:null},m.getUserRole=function(){var a=d.get(e.userProfileName);return a?a.role:null},m.signout=function(){return g.remove(),h.remove(),f.clear(),f.set(),c.rejectAll("signed out"),b.$broadcast(m.EVENTS.SIGNOUT),a.when(!0)},m.signup=function(a,b,c,d,f){return i({method:"POST",url:e.apiUrl+"/1/user/signup",headers:{SignUpToken:e.signUpToken},data:{firstName:a,lastName:b,email:c,password:d,confirmPassword:f}})},m.requestResetPassword=function(a,b){return b&&m.setAppName(b),i({method:"POST",url:e.apiUrl+"/1/user/requestResetPassword",data:{appName:e.appName,username:a}})},m.resetPassword=function(a,b){return i({method:"POST",url:e.apiUrl+"/1/user/resetPassword",data:{newPassword:a,resetToken:b}})},m.changePassword=function(a,b){return i({method:"POST",url:e.apiUrl+"/1/user/changePassword",data:{oldPassword:a,newPassword:b}})},m.refreshToken=function(){f.clear("Authorization");var a={grant_type:"password",refreshToken:h.get().refresh_token,username:m.getUsername(),appName:e.appName};return l(a)},m.getToken=function(){return g.get()},m.getTokenName=function(){return e.tokenName},m.getApiUrl=function(){return e.apiUrl},m.socialSignIn=m.socialSignin,m.socialSignUp=m.socialSignup,m.signInWithToken=m.signinWithToken}e={apiUrl:"https://api.backand.com",tokenName:"backand_token",anonymousToken:null,signUpToken:null,isManagingDefaultHeaders:!1,appName:null,userProfileName:"backand_user"},g={get:function(){return d.get(e.tokenName)},set:function(a){d.put(e.tokenName,a)},remove:function(){d.remove(e.tokenName)}},h={get:function(){return d.get(e.userProfileName)},set:function(a){d.put(e.userProfileName,a)},remove:function(){d.remove(e.userProfileName)}},f={set:function(){if(e.isManagingDefaultHeaders){var a=g.get();angular.isDefined(a)&&(i.defaults.headers.common.Authorization=a),e.anonymousToken&&(i.defaults.headers.common.AnonymousToken=e.anonymousToken)}},clear:function(a){e.isManagingDefaultHeaders&&(a?i.defaults.headers.common[a]&&delete i.defaults.headers.common[a]:(i.defaults.headers.common.Authorization&&delete i.defaults.headers.common.Authorization,i.defaults.headers.common.AnonymousToken&&delete i.defaults.headers.common.AnonymousToken))}},this.getApiUrl=function(){return e.apiUrl},this.setApiUrl=function(a){return e.apiUrl=a,this},this.getTokenName=function(a){return e.tokenName},this.setTokenName=function(a){return e.tokenName=a,this},this.setAnonymousToken=function(a){return e.anonymousToken=a,this},this.setSignUpToken=function(a){return e.signUpToken=a,this},this.setAppName=function(a){return e.appName=a,this},this.manageDefaultHeaders=function(a){return void 0==a&&(a=!0),e.isManagingDefaultHeaders=a,this},this.$get=["$q","$rootScope","BackandHttpBufferService",function(b,c,d){return new a(b,c,d)}]}).config(["$httpProvider",function(a){a.interceptors.push("BackandHttpInterceptor")}]).run(["$injector",function(a){a.invoke(["$http","$cookieStore",function(a,b){d=b,i=a}]),f.set()}])}(),function(){function a(a,b,c){return{responseError:function(d){if(d.config.url!==b.getApiUrl()+"token"&&401===d.status){b.refreshToken();var e=a.defer();return c.append(d.config,e),e.promise}return a.reject(d)}}}angular.module("backand").factory("BackandHttpInterceptor",["$q","Backand","BackandHttpBufferService",a])}(),function(){function a(a){function b(b,c){function d(a){c.resolve(a)}function e(a){c.reject(a)}var f=a.get("$http");f=f||a.get("$http"),f(b).then(d,e)}function c(a){return delete a.headers.Authorization,a}var d=this,e=[];d.append=function(a,b){e.push({config:a,deferred:b})},d.rejectAll=function(a){if(a)for(var b=0;b<e.length;++b)e[b].deferred.reject(a);e=[]},d.retryAll=function(){for(var a=0;a<e.length;++a)b(c(e[a].config),e[a].deferred);e=[]}}angular.module("backand").service("BackandHttpBufferService",["$injector",a])}();