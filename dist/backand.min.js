/*
* Angular SDK to use with backand 
* @version 1.7.0 - 2015-08-02
* @link https://backand.com 
* @author Itay Herskovits 
* @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";var a=/\?(data|error)=(.+)/,b=a.exec(location.href);if(b&&b[1]&&b[2]){var c={};c[b[1]]=JSON.parse(decodeURI(b[2].replace(/#.*/,""))),window.opener.postMessage(JSON.stringify(c),location.origin)}var d,e,f,g,h,i;angular.module("backand",["ngCookies"]).provider("Backand",function(){function a(a){function b(a,b){var c=l[a],d=b?"up":"in";return"user/socialSign"+d+"?provider="+c.label+"&response_type=token&client_id=self&redirect_uri="+c.url+"&state="}function c(a){if(k.socialAuthWindow.close(),k.socialAuthWindow=null,a.origin===location.origin){var b=JSON.parse(a.data);return b.error?void k.loginPromise.reject({data:b.error.message+" (signing in with "+b.error.provider+")"}):b.data?k.signInWithToken(b.data):void k.loginPromise.reject()}}function j(a){return g.remove(),f.clear(),i({method:"POST",url:e.apiUrl+"/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];return angular.forEach(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(a))}),b.join("&")},data:a}).success(function(a){angular.isDefined(a)&&null!=a?angular.isDefined(a.access_token)&&(e.token="bearer "+a.access_token,g.set(e.token),f.set(),h.set(a),k.loginPromise.resolve(e.token)):k.loginPromise.reject("token is undefined")}).error(function(a){k.loginPromise.reject(a)}),k.loginPromise.promise}var k=this;k.setAppName=function(a){e.appName=a};var l={github:{name:"github",label:"Github",url:"www.github.com",css:"github",id:1},google:{name:"google",label:"Google",url:"www.google.com",css:"google-plus",id:2},facebook:{name:"facebook",label:"Facebook",url:"www.facebook.com",css:"facebook",id:3}};k.getSocialProviders=function(){return l},k.socialSignIn=function(a){return k.socialAuth(a,!1)},k.socialSignUp=function(a){return k.socialAuth(a,!0)},k.socialAuth=function(d,f){return k.loginPromise=a.defer(),k.socialAuthWindow=window.open(e.apiUrl+"/1/"+b(d,f)+"&appname="+e.appName+"&returnAddress=","id1","left=10, top=10, width=600, height=600"),window.addEventListener("message",c,!1),k.loginPromise.promise},k.signin=function(b,c,d){k.loginPromise=a.defer(),d&&k.setAppName(d);var f={grant_type:"password",username:b,password:c,appname:e.appName};return j(f)},k.signInWithToken=function(a){var b={grant_type:"password",accessToken:a.access_token,appName:e.appName};return j(b)},k.getUserDetails=function(b){var c=a.defer();return b?i({method:"GET",url:e.apiUrl+"/1/account/profile"}).success(function(a){h.set(a),c.resolve(h.get())}):c.resolve(h.get()),c.promise},k.getUsername=function(){var a=d.get(e.userProfileName);return a?a.username:null},k.getUserRole=function(){var a=d.get(e.userProfileName);return a?a.role:null},k.signout=function(){return g.remove(),h.remove(),f.clear(),f.set(),a.when(!0)},k.signup=function(a,b,c,d,f){return i({method:"POST",url:e.apiUrl+"/1/user/signup",headers:{SignUpToken:e.signUpToken},data:{firstName:a,lastName:b,email:c,password:d,confirmPassword:f}})},k.requestResetPassword=function(a,b){return b&&k.setAppName(b),i({method:"POST",url:e.apiUrl+"/1/user/requestResetPassword",data:{appName:e.appName,username:a}})},k.resetPassword=function(a,b){return i({method:"POST",url:e.apiUrl+"/1/user/resetPassword",data:{newPassword:a,resetToken:b}})},k.changePassword=function(a,b){return i({method:"POST",url:e.apiUrl+"/1/user/changePassword",data:{oldPassword:a,newPassword:b}})},k.getToken=function(){return g.get()},k.getTokenName=function(){return e.tokenName},k.getApiUrl=function(){return e.apiUrl}}e={apiUrl:"https://api.backand.com",tokenName:"backand_token",anonymousToken:null,signUpToken:null,isManagingDefaultHeaders:!1,appName:null,userProfileName:"backand_user"},g={get:function(){return d.get(e.tokenName)},set:function(a){d.put(e.tokenName,a)},remove:function(){d.remove(e.tokenName)}},h={get:function(){return d.get(e.userProfileName)},set:function(a){d.put(e.userProfileName,a)},remove:function(){d.remove(e.userProfileName)}},f={set:function(){if(e.isManagingDefaultHeaders){var a=g.get();angular.isDefined(a)&&(i.defaults.headers.common.Authorization=a),e.anonymousToken&&(i.defaults.headers.common.AnonymousToken=e.anonymousToken)}},clear:function(){e.isManagingDefaultHeaders&&(i.defaults.headers.common.Authorization&&delete i.defaults.headers.common.Authorization,i.defaults.headers.common.AnonymousToken&&delete i.defaults.headers.common.AnonymousToken)}},this.getApiUrl=function(){return e.apiUrl},this.setApiUrl=function(a){return e.apiUrl=a,this},this.getTokenName=function(a){return e.tokenName},this.setTokenName=function(a){return e.tokenName=a,this},this.setAnonymousToken=function(a){return e.anonymousToken=a,this},this.setSignUpToken=function(a){return e.signUpToken=a,this},this.setAppName=function(a){return e.appName=a,this},this.manageDefaultHeaders=function(a){return void 0==a&&(a=!0),e.isManagingDefaultHeaders=a,this},this.$get=["$q",function(b){return new a(b)}]}).run(["$injector","$location",function(a,b){a.invoke(["$http","$cookieStore",function(a,b){d=b,i=a}]),f.set()}])}();