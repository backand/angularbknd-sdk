/*
* Angular SDK to use with backand 
* @version 1.7.2 - 2015-09-06
* @link https://backand.com 
* @author Itay Herskovits 
* @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){function a(a,b){var c=i[a],d=b?"up":"in";return"user/socialSign"+d+"?provider="+c.label+"&response_type=token&client_id=self&redirect_uri="+c.url+"&state="}function b(a,b,c,d){return{request:function(a){if(!b.isManagingDefaultHeaders())return a;if(!a.url.match(b.getApiUrl()))return a;if(a.url.match(b.getApiUrl()+"/token"))return a;var c=f.token.get();return angular.isDefined(c)&&(a.headers.Authorization=c),g.anonymousToken&&(a.headers.AnonymousToken=g.anonymousToken),a},responseError:function(e){if(e.config.url!==b.getApiUrl()+"token"&&401===e.status){d.refreshToken(b.getUsername());var f=a.defer();return c.append(e.config,f),f.promise}return a.reject(e)}}}function c(b,c,d){function j(a){if(l.socialAuthWindow.close(),l.socialAuthWindow=null,a.origin===location.origin){var b=JSON.parse(a.data);if(b.error){var c={data:b.error.message+" (signing in with "+b.error.provider+")"};c.error_description=c.data,l.loginPromise.reject(c)}else{if(b.data)return l.signinWithToken(b.data);l.loginPromise.reject()}}}function k(a){return m?void 0:(m=!0,f.token.clear(),e({method:"POST",url:g.apiUrl+"/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];return angular.forEach(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(a))}),b.join("&")},data:a}).then(function(a){return a.data&&a.data.access_token?(g.token="bearer "+a.data.access_token,f.token.set(g.token),f.user.set(a.data),l.loginPromise&&l.loginPromise.resolve(g.token),d.retryAll(),c.$broadcast(h.SIGNIN)):l.loginPromise&&l.loginPromise.reject("token is undefined"),a.data})["catch"](function(a){return l.loginPromise&&l.loginPromise.reject(a),b.reject(a.data)})["finally"](function(){m=!1}))}var l=this,m=!1;l.signin=function(a,b){var c={grant_type:"password",username:a,password:b,appname:g.appName};return k(c)},l.signout=function(){return f.token.clear(),f.user.clear(),d.rejectAll("signed out"),c.$broadcast(h.SIGNOUT),b.when(!0)},l.signup=function(a,b,d,f,i,j){return e({method:"POST",url:g.apiUrl+"/1/user/signup",headers:{SignUpToken:g.signUpToken},data:{firstName:a,lastName:b,email:d,password:f,confirmPassword:i,parameters:j}}).then(function(a){return c.$broadcast(h.SIGNUP),a})},l.socialAuth=function(c,d,e){if(!i[c])throw Error("Unknown Social Provider");return l.loginPromise=b.defer(),l.socialAuthWindow=window.open(g.apiUrl+"/1/"+a(c,d)+"&appname="+g.appName+"&returnAddress=","id1",e||"left=1, top=1, width=600, height=600"),window.addEventListener("message",j,!1),l.loginPromise.promise},l.signinWithToken=function(a){var b={grant_type:"password",accessToken:a.access_token,appName:g.appName};return k(b)},l.refreshToken=function(a){f.token.clear();var b,c=f.user.get();if(c&&(b=f.user.get().refresh_token)){var d={grant_type:"password",refreshToken:b,username:a,appName:g.appName};return k(d)}},l.requestResetPassword=function(a,b){return b&&l.setAppName(b),e({method:"POST",url:g.apiUrl+"/1/user/requestResetPassword",data:{appName:g.appName,username:a}})},l.resetPassword=function(a,b){return e({method:"POST",url:g.apiUrl+"/1/user/resetPassword",data:{newPassword:a,resetToken:b}})},l.changePassword=function(a,b){return e({method:"POST",url:g.apiUrl+"/1/user/changePassword",data:{oldPassword:a,newPassword:b}})}}function d(a){var b=this;b.getUserDetails=function(b){var c=a.defer();return b?e({method:"GET",url:g.apiUrl+"/api/account/profile"}).success(function(a){f.user.set(a),c.resolve(f.user.get())}):c.resolve(f.user.get()),c.promise},b.getUsername=function(){var a;return(a=f.user.get())?a.username:null},b.getUserRole=function(){var a;return(a=f.user.get())?a.role:null}}var e,f=function(){"use strict";function a(a,c){var d;-1===["local","session"].indexOf(c)&&(c="local"),d="undefined"!=typeof window&&"undefined"!=typeof window[c+"Storage"]?window[c+"Storage"]:{value:null,getItem:function(a,b){return this.value},setItem:function(a,b){this.value=b},removeItem:function(a,b){this.value=null}},this.command=function(c,e){return d[c+"Item"](b+a,e||null)}}var b="BACKAND";return a.prototype.get=function(){return JSON.parse(this.command("get"))},a.prototype.set=function(a){return this.command("set",JSON.stringify(a))},a.prototype.clear=function(){return this.command("set"),this},{register:function(b,c){if(!b)throw Error("Invalid Store Name");return this[b]=new a(b,c),this},remove:function(a){return this[a].command("remove"),delete this[a],this}}}(),g={apiUrl:"https://api.backand.com",tokenName:"backand_token",anonymousToken:null,signUpToken:null,isManagingDefaultHeaders:!0,appName:null,userProfileName:"backand_user"},h={SIGNIN:"BackandSignIn",SIGNOUT:"BackandSignOut",SIGNUP:"BackandSignUp"},i={github:{name:"github",label:"Github",url:"www.github.com",css:"github",id:1},google:{name:"google",label:"Google",url:"www.google.com",css:"google-plus",id:2},facebook:{name:"facebook",label:"Facebook",url:"www.facebook.com",css:"facebook",id:3}};f.register("token"),f.register("user"),function(){var a=/\?(data|error)=(.+)/,b=a.exec(location.href);if(b&&b[1]&&b[2]){var c={};c[b[1]]=JSON.parse(decodeURI(b[2].replace(/#.*/,""))),window.opener.postMessage(JSON.stringify(c),location.origin)}}(),angular.module("backand",[]).provider("Backand",function(){function a(a,b){var c=this;c.EVENTS=h,c.setAppName=function(a){g.appName=a},c.signin=function(b,d,e){return e&&c.setAppName(e),a.signin(b,d)},c.signout=function(){return a.signout()},c.signup=function(b,c,d,e,f,g){return a.signup(b,c,d,e,f,g)},c.getSocialProviders=function(){return i},c.socialSignin=function(b,c){return a.socialAuth(b,!1,c)},c.socialSignup=function(b,c){return a.socialAuth(b,!0,c)},c.requestResetPassword=function(b,d){return d&&c.setAppName(d),a.requestResetPassword(b,d)},c.resetPassword=function(b,c){return a.resetPassword(b,c)},c.changePassword=function(b,c){return a.changePassword(b,c)},c.getUserDetails=function(a){return b.getUserDetails(a)},c.getUsername=function(){return b.getUsername()},c.getUserRole=function(){return b.getUserRole()},c.getToken=function(){return f.token.get()},c.getTokenName=function(){return g.tokenName},c.getApiUrl=function(){return g.apiUrl},c.isManagingDefaultHeaders=function(){return g.isManagingDefaultHeaders},c.socialSignIn=c.socialSignin,c.socialSignUp=c.socialSignup,c.signInWithToken=c.signinWithToken}this.getApiUrl=function(){return g.apiUrl},this.setApiUrl=function(a){return g.apiUrl=a,this},this.getTokenName=function(a){return g.tokenName},this.setTokenName=function(a){return g.tokenName=a,this},this.setAnonymousToken=function(a){return g.anonymousToken=a,this},this.setSignUpToken=function(a){return g.signUpToken=a,this},this.setAppName=function(a){return g.appName=a,this},this.manageDefaultHeaders=function(a){return g.isManagingDefaultHeaders=void 0==a?!0:a,this},this.$get=["BackandAuthService","BackandUserService",function(b,c){return new a(b,c)}]}).run(["$injector",function(a){a.invoke(["$http",function(a){e=a}])}]),angular.module("backand").factory("BackandHttpInterceptor",["$q","Backand","BackandHttpBufferService","BackandAuthService",b]).config(["$httpProvider",function(a){a.interceptors.push("BackandHttpInterceptor")}]),angular.module("backand").service("BackandAuthService",["$q","$rootScope","BackandHttpBufferService",c]),function(){function a(){function a(a,b){function c(a){b.resolve(a)}function d(a){b.reject(a)}e(a).then(c,d)}function b(a){return delete a.headers.Authorization,a}var c=this,d=[];c.append=function(a,b){d.push({config:a,deferred:b})},c.rejectAll=function(a){if(a)for(var b=0;b<d.length;++b)d[b].deferred.reject(a);d=[]},c.retryAll=function(){for(var c=0;c<d.length;++c)a(b(d[c].config),d[c].deferred);d=[]}}angular.module("backand").service("BackandHttpBufferService",a)}(),angular.module("backand").service("BackandUserService",["$q",d])}();