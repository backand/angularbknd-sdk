/*
* Angular SDK to use with backand 
* @version 1.7.2 - 2015-08-31
* @link https://backand.com 
* @author Itay Herskovits 
* @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";var a=/\?(data|error)=(.+)/,b=a.exec(location.href);if(b&&b[1]&&b[2]){var c={};c[b[1]]=JSON.parse(decodeURI(b[2].replace(/#.*/,""))),window.opener.postMessage(JSON.stringify(c),location.origin)}var d,e,f,g,h,i;angular.module("backand",["ngCookies"]).provider("Backand",function(){function a(a,b){function c(a,b){var c=m[a],d=b?"up":"in";return"user/socialSign"+d+"?provider="+c.label+"&response_type=token&client_id=self&redirect_uri="+c.url+"&state="}function j(a){if(l.socialAuthWindow.close(),l.socialAuthWindow=null,a.origin===location.origin){var b=JSON.parse(a.data);return b.error?void l.loginPromise.reject({data:b.error.message+" (signing in with "+b.error.provider+")"}):b.data?l.signInWithToken(b.data):void l.loginPromise.reject()}}function k(a){return g.remove(),f.clear(),i({method:"POST",url:e.apiUrl+"/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];return angular.forEach(a,function(a,c){b.push(encodeURIComponent(c)+"="+encodeURIComponent(a))}),b.join("&")},data:a}).success(function(a){angular.isDefined(a)&&null!=a?angular.isDefined(a.access_token)&&(e.token="bearer "+a.access_token,g.set(e.token),f.set(),h.set(a),l.loginPromise.resolve(e.token),b.$broadcast(l.EVENTS.SIGNIN)):l.loginPromise.reject("token is undefined")}).error(function(a){l.loginPromise.reject(a)}),l.loginPromise.promise}var l=this;l.EVENTS={SIGNIN:"BackandSignIn",SIGNOUT:"BackandSignOut"},l.setAppName=function(a){e.appName=a};var m={github:{name:"github",label:"Github",url:"www.github.com",css:"github",id:1},google:{name:"google",label:"Google",url:"www.google.com",css:"google-plus",id:2},facebook:{name:"facebook",label:"Facebook",url:"www.facebook.com",css:"facebook",id:3}};l.getSocialProviders=function(){return m},l.socialSignin=function(a){return l.socialAuth(a,!1)},l.socialSignup=function(a){return l.socialAuth(a,!0)},l.socialAuth=function(b,d){return l.loginPromise=a.defer(),l.socialAuthWindow=window.open(e.apiUrl+"/1/"+c(b,d)+"&appname="+e.appName+"&returnAddress=","id1","left=10, top=10, width=600, height=600"),window.addEventListener("message",j,!1),l.loginPromise.promise},l.signin=function(b,c,d){l.loginPromise=a.defer(),d&&l.setAppName(d);var f={grant_type:"password",username:b,password:c,appname:e.appName};return k(f)},l.signinWithToken=function(b){l.loginPromise=a.defer();var c={grant_type:"password",accessToken:b.access_token,appName:e.appName};return k(c)},l.getUserDetails=function(b){var c=a.defer();return b?i({method:"GET",url:e.apiUrl+"/api/account/profile"}).success(function(a){h.set(a),c.resolve(h.get())}):c.resolve(h.get()),c.promise},l.getUsername=function(){var a=d.get(e.userProfileName);return a?a.username:null},l.getUserRole=function(){var a=d.get(e.userProfileName);return a?a.role:null},l.signout=function(){return g.remove(),h.remove(),f.clear(),f.set(),b.$broadcast(l.EVENTS.SIGNOUT),a.when(!0)},l.signup=function(a,b,c,d,f){return i({method:"POST",url:e.apiUrl+"/1/user/signup",headers:{SignUpToken:e.signUpToken},data:{firstName:a,lastName:b,email:c,password:d,confirmPassword:f}})},l.requestResetPassword=function(a,b){return b&&l.setAppName(b),i({method:"POST",url:e.apiUrl+"/1/user/requestResetPassword",data:{appName:e.appName,username:a}})},l.resetPassword=function(a,b){return i({method:"POST",url:e.apiUrl+"/1/user/resetPassword",data:{newPassword:a,resetToken:b}})},l.changePassword=function(a,b){return i({method:"POST",url:e.apiUrl+"/1/user/changePassword",data:{oldPassword:a,newPassword:b}})},l.getToken=function(){return g.get()},l.getTokenName=function(){return e.tokenName},l.getApiUrl=function(){return e.apiUrl},l.socialSignIn=l.socialSignin,l.socialSignUp=l.socialSignup,l.signInWithToken=l.signinWithToken}e={apiUrl:"https://api.backand.com",tokenName:"backand_token",anonymousToken:null,signUpToken:null,isManagingDefaultHeaders:!1,appName:null,userProfileName:"backand_user"},g={get:function(){return d.get(e.tokenName)},set:function(a){d.put(e.tokenName,a)},remove:function(){d.remove(e.tokenName)}},h={get:function(){return d.get(e.userProfileName)},set:function(a){d.put(e.userProfileName,a)},remove:function(){d.remove(e.userProfileName)}},f={set:function(){if(e.isManagingDefaultHeaders){var a=g.get();angular.isDefined(a)&&(i.defaults.headers.common.Authorization=a),e.anonymousToken&&(i.defaults.headers.common.AnonymousToken=e.anonymousToken)}},clear:function(){e.isManagingDefaultHeaders&&(i.defaults.headers.common.Authorization&&delete i.defaults.headers.common.Authorization,i.defaults.headers.common.AnonymousToken&&delete i.defaults.headers.common.AnonymousToken)}},this.getApiUrl=function(){return e.apiUrl},this.setApiUrl=function(a){return e.apiUrl=a,this},this.getTokenName=function(a){return e.tokenName},this.setTokenName=function(a){return e.tokenName=a,this},this.setAnonymousToken=function(a){return e.anonymousToken=a,this},this.setSignUpToken=function(a){return e.signUpToken=a,this},this.setAppName=function(a){return e.appName=a,this},this.manageDefaultHeaders=function(a){return void 0==a&&(a=!0),e.isManagingDefaultHeaders=a,this},this.$get=["$q","$rootScope",function(b,c){return new a(b,c)}]}).run(["$injector","$location",function(a,b){a.invoke(["$http","$cookieStore",function(a,b){d=b,i=a}]),f.set()}])}();